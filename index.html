<!doctype HTML>
<html>
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
    <title>Norville's Frame Chart Calculator</title>
	<meta name="tagline" content="You know, for kids!">
	<meta name="author" content="Peter Postma">
	<meta name="revised" content="August 9th, 2020, 11:01pm">
	
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="nouislider.min.js"></script>

	<link href="nouislider.min.css" rel="stylesheet">

	<style>
		body {
			font-family: "Liberation Sans", sans-serif;
			font-size: 0.9em;
			line-height: 1.5;
		}
		input[type=text] {
			font-size: 1em;
			width: 4em;
			margin-right: 1em;
		}
		fieldset {
			border: 1px black solid;
			width: 50em;
			padding: 1em;
		}
		#sourceBox {
			padding: 0.5em;
		}
		#destAspect {
			margin-right: 0em;
			margin-top: 0.6em
		}
		#sliderBox {
			position: relative;
			padding: 0px 20px 5px 20px;
			margin: 20px 5px;
			overflow: hidden;
			width: 50em;
		}
		#safety-slider-label {
			margin-top: 2.5em;
			width: 100%;
		}
		#safety-slider-label input {
            display: block;
            margin : 0 auto;
			width: 6em;
		}
		#safety-slider-min-label {
			float: left;
			color: #999;
		}
		#safety-slider-max-label {
			text-align: right;
			float: right;
			color: #999;
		}
		#calculatedValues {
			font-weight: bold;
		}
		#calculatedValues span {
			font-weight: normal;
		}
		.noUi-pips-horizontal {
			height: 20px;
		}
		#calculatedValues fieldset {
			border: 1px black solid;
			width: 24em;
		}
		legend {
			border: 1px black solid;
			margin-left: 1em;
			padding: 0em 0.8em;
			font-weight: bold;
		}
		#footer {
			margin: 1.5em;
			font-size: 0.8em;
		}
		#calModeBox {
			margin-top: 1em;
		}
		#calModeBox label {
			margin-right: 2em;
		}
		#heightVariance {
			color: #F99;
		}
		#canvasBox {
			width: 50em;
			margin-top: 1em;
		}
		#framelineCanvas {
		    padding-left: 0;
		    padding-right: 0;
		    margin-left: auto;
		    margin-right: auto;
		    display: block;
		    width: 90%;
		}
	</style>
	
	<script>
		let uiVars = {
		 	sourceWidth: 4096,
			sourceHeight: 2160,
			sourceAspect: 1.0,
		 	destWidth: 4096,
			destHeight: 0,    //calulated
			destAspect: 2.351,
		};
		let calcVals = {
			extractionX: 0,
			extractionY: 0,
			extractionWidth: 0,
			extractionHeight: 0,
			aspectRatio: 0,
			hScale: 0,
			vScale: 0,
			hSafety: 0,
			vSafety: 0
		};
		let subpixelMode = true;
		let evenMode = false;
		let heightVariance = 0.0;
		var ctx;
		
		function calculateValues() {
			var safetyMargin = parseFloat($('#safety-margin').val()) / 100.0;
			
			calcVals.extractionWidth = uiVars.sourceWidth - (uiVars.sourceWidth * safetyMargin);
			calcVals.extractionX = (uiVars.sourceWidth - calcVals.extractionWidth) / 2.0;
			calcVals.hScale = uiVars.destWidth / calcVals.extractionWidth;
			calcVals.hSafety = (uiVars.sourceWidth - calcVals.extractionWidth) / uiVars.sourceWidth * 100.0;
			
			calcVals.aspectRatio = uiVars.destAspect;
			
			calcVals.extractionHeight = calcVals.extractionWidth / uiVars.destAspect * uiVars.sourceAspect;
			calcVals.vScale = uiVars.destWidth / uiVars.destAspect / calcVals.extractionHeight;
			calcVals.vSafety = (uiVars.sourceHeight - calcVals.extractionHeight) / uiVars.sourceHeight * 100.0;
			heightVariance = 0.0
			if (!subpixelMode) {
				var newHeight = Math.round(calcVals.extractionHeight);
				if (evenMode)
					newHeight = 2 * Math.round(calcVals.extractionHeight / 2);					
				heightVariance = calcVals.extractionHeight - newHeight;
				calcVals.extractionHeight = newHeight;
				calcVals.aspectRatio = calcVals.extractionWidth * uiVars.sourceAspect / calcVals.extractionHeight;
			}
			calcVals.extractionY = (uiVars.sourceHeight - calcVals.extractionHeight) / 2.0;
		}
		
		
		function draw_frame_line() {			
			const width = $("#framelineCanvas").width();
			const height = $("#framelineCanvas").height();
			
			ctx.clearRect(0, 0, width, height);

			var hScale = width / uiVars.sourceWidth;
			var vScale = hScale;
			if ( uiVars.sourceHeight * vScale > height) {
				vScale = height/ uiVars.sourceHeight;
				hScale = vScale;
			}
			var offsetX = (width - uiVars.sourceWidth * hScale) / 2;
			var offsetY = (height - uiVars.sourceHeight * vScale) / 2;

			ctx.fillStyle = '#999'
			ctx.fillRect(offsetX, offsetY, uiVars.sourceWidth * hScale, uiVars.sourceHeight * vScale);
			
			ctx.fillStyle = '#99F'
			ctx.fillRect(offsetX + calcVals.extractionX * hScale, offsetY + calcVals.extractionY * vScale,
						calcVals.extractionWidth * hScale, calcVals.extractionHeight * vScale);
			
			ctx.beginPath();
			ctx.moveTo(width / 2, height / 2 - 10);
			ctx.lineTo(width / 2, height / 2 + 10);
			ctx.moveTo(width / 2 - 10, height / 2);
			ctx.lineTo(width / 2 + 10, height / 2);
			ctx.stroke();
		}
		
		function update_fields() {
			uiVars.destHeight = Math.round(uiVars.destWidth / uiVars.destAspect);

			calculateValues();
			
			for (let [key, value] of Object.entries(uiVars)) {
				$('#'+key).val(value);
			}
			for (let [key, value] of Object.entries(calcVals)) {
				var precision = 5
				if (!subpixelMode && String(key).startsWith('extraction')) {
					precision = (key === 'extractionX' || key === 'extractionY') ? 1 : 0; 
				}
				$('#'+key).text(value.toFixed(precision));
			}
			if (heightVariance != 0.0) {
				$('#heightVariance').text( ((heightVariance > 0) ? '+' : '') + heightVariance.toFixed(5) );
			} else {
				$('#heightVariance').text('');
			}

			draw_frame_line();
		}
		
		function click_on_pip() {
		    var value = parseFloat(this.getAttribute('data-value'));
			if (parseFloat(this.style.left) > 99)
				value += 0.00001;
		    safetySlider.noUiSlider.set(value);
		}

		function update_slider_range() {
			var minPercentage = 0.0;
			var minWidth = uiVars.sourceWidth;
			if (uiVars.sourceHeight * uiVars.destAspect / uiVars.sourceAspect < minWidth) {
				minWidth = (uiVars.sourceHeight * uiVars.destAspect / uiVars.sourceAspect);
				if (!subpixelMode) {
					minWidth = Math.floor(minWidth);
					if (evenMode && minWidth % 2 != 0)
						minWidth--
				}
				minPercentage =  (uiVars.sourceWidth - minWidth) / uiVars.sourceWidth * 100.0;
			}
			
			// Keep slide to usable range (not to sensitive and withing realistic bounds)
			var maxPercentage = ( minPercentage < 50.0 ) ? 50.0 : minPercentage + 20;
			if (maxPercentage > 99.0)
				maxPercentage = 99.0
			if (maxPercentage > minPercentage + 25.0) {
				maxPercentage = minPercentage + 25.0
				$('#safety-slider-max-label').html('<br>');
			} else {
				$('#safety-slider-max-label').html((uiVars.sourceAspect != 1.0 ? 'horizontal' : 'pixel') + ' doubling<br>');
			}
			var maxWidth = (1.0 - (maxPercentage / 100.0)) * uiVars.sourceWidth;
			if (!subpixelMode) {
				maxWidth = Math.round(maxWidth);
				if (evenMode) {
					maxWidth = 2 * Math.round(maxWidth / 2);
				}
				maxPercentage = (uiVars.sourceWidth - maxWidth) / uiVars.sourceWidth * 100.0;
			}
			
			var midPercentage = maxPercentage / 2.0;
			if ((uiVars.sourceWidth * uiVars.sourceAspect) > uiVars.destWidth) {				
				midPercentage = (uiVars.sourceWidth - uiVars.destWidth) / uiVars.sourceWidth * 100.0
			}
			if (midPercentage < minPercentage) {
				midPercentage = minPercentage + (maxPercentage - minPercentage) / 2.0;
			}

	        let sliderRange = {
	            'min': minPercentage,
	            'max': maxPercentage
	        }
			if (!subpixelMode) {
				var steps = minWidth-maxWidth;
				var interval = (maxPercentage - minPercentage) / steps;
				for ( var i = (evenMode) ? 2 : 1; i < steps; (evenMode) ? i = i + 2 : i++) {
					var key = (i * (100.0 / steps)) + '%';
					sliderRange[key] = (1.0 - ((minWidth - i) / uiVars.sourceWidth)) * 100.0;
				}
			}

			safetySlider.noUiSlider.updateOptions({
		        range: sliderRange,
				snap: (!subpixelMode),
			    pips: {
			        mode: 'values',
					values: [minPercentage, midPercentage, maxPercentage-0.00001],
			        density: 5
			    }
	    	});

			var pips = safetySlider.querySelectorAll('.noUi-value');

			for (var i = 0; i < pips.length; i++) {
			    pips[i].style.cursor = 'pointer';
			    pips[i].addEventListener('click', click_on_pip);
			}
		}
		
		function parse_URL() {
			var queries = window.location.search.replace(/^\?/, '').split('&'), split;
			var safetyMargin = 0;
		    for( var i = 0; i < queries.length; i++ ) {
		        split = queries[i].split('=');
				if (split[0] in uiVars) {
					if (split[0].includes('Aspect'))
						uiVars[split[0]] = parseFloat(split[1]);
					else
						uiVars[split[0]] = parseInt(split[1]);
				} else if (split[0] === 'mode') {
					if (split[1] === 'single') {
						subpixelMode = false;
						$('#calcMode_Subpixel').prop('checked',false);
						$('#calcMode_Singlepixel').prop('checked',true);
					}
					if (split[1] === 'double') {
						evenMode = true;
						subpixelMode = false;
						$('#calcMode_Subpixel').prop('checked',false);
						$('#calcMode_Doublepixel').prop('checked',true);
					}
				} else if (split[0] === 'safetyMargin') {
					safetyMargin = split[1];
				}
		    }
			update_slider_range();
			if (safetyMargin != 0)
				$('#safety-margin').val(safetyMargin).change();

		}
		
		const copyToClipboard = str => {
			const el = document.createElement('textarea');
			el.value = str;
			el.setAttribute('readonly', '');
			el.style.position = 'absolute';
			el.style.left = '-9999px';
			document.body.appendChild(el);
			const selected = document.getSelection().rangeCount > 0 ? document.getSelection().getRangeAt(0) : false;
			el.select();
			document.execCommand('copy');
			document.body.removeChild(el);
			if (selected) {
				document.getSelection().removeAllRanges();
				document.getSelection().addRange(selected);
			}
		};
		
		function make_link() {
			var url = window.location.href.split('?')[0] + '?';
			for (let [key, value] of Object.entries(uiVars)) {
				url += key + '=' + value + '&';
			}
			if (evenMode)
				url += 'mode=double&';
			else if (!subpixelMode)
				url += 'mode=single&';
			url += 'safetyMargin=' + $('#safety-margin').val();
			copyToClipboard(url);
		}
		
    </script>
</head>
<body onLoad="parse_URL()">
	<div id="sourceBox">
	    <fieldset>
	      <legend>Source</legend>
			Width <input id="sourceWidth" type="text" class="uiVar"/>
			Height <input id="sourceHeight" type="text" class="uiVar"/>
			Pixel Aspect <input id="sourceAspect" type="text" class="uiVar"/><br>
			Framing Aspect Ratio <input id="destAspect" type="text" class="uiVar"/><span style="margin-right: 1em">:1</span>
		</fieldset>
	</div>
    <div id="sliderBox">
		Percent Safety Margin (Width)
        <div id="safety-slider"></div>
        <div id="safety-slider-label">
			<span id="safety-slider-min-label">full width</span>
			<span id="safety-slider-max-label"></span>
			<input id="safety-margin" type="text"/>
		</div>
	    <script>
			var safetySlider = document.getElementById('safety-slider');

			noUiSlider.create(safetySlider, {
			    start: [0],
			    range: {
			        'min': 0,
			        'max': 100
			    },
			    pips: {
			        mode: 'values',
					values: [0, 50, 100],
			        density: 4
			    },
			});
		</script>
	</div>
	<div id="calculatedValues">
	    <fieldset style="float: left">
	      <legend>Extraction Area</legend>
			Top-left X: <span id="extractionX"></span><br>
			Top-left Y: <span id="extractionY"></span><br><br>
			Width: <span id="extractionWidth"></span><br>
			Height: <span id="extractionHeight"></span> <span id="heightVariance"></span><br><br>
			Aspect ratio: <span id="aspectRatio"></span><br>
	    </fieldset>
	    <fieldset>
	      <legend>Safety Margin</legend>
			Horizontal (%): <span id="hSafety"></span><br>
			Vertical (%): <span id="vSafety"></span><br>
		</fieldset>
		<fieldset style="margin-top: 0.5em">
  	      <legend>Resized Output</legend>	
  			Width <input id="destWidth" type="text" class="uiVar"/>
  			Height <input id="destHeight" type="text" disabled/><br>
			Horizontal scale: <span id="hScale"></span><br>
			Vertical scale: <span id="vScale"></span><br>
	    </fieldset>
	</div>
	<div id="canvasBox">
		<canvas id="framelineCanvas"></canvas>
	</div>
	<div id="calModeBox">
	    <fieldset>
			<legend>Extraction Rounding Mode</legend>
			<form id="calcModeRadioBox">
				<input type="radio" name="calcMode" id="calcMode_Subpixel" value="Subpixel" CHECKED/><label for="calcMode_Subpixel">Subpixel </label>
				<input type="radio" name="calcMode" id="calcMode_Singlepixel" value="Singlepixel"/><label for="calcMode_Singlepixel">Whole pixel</label>
				<input type="radio" name="calcMode" id="calcMode_Doublepixel" value="Doublepixel"/><label for="calcMode_Doublepixel">Even pixel</label>
			</form>
		</fieldset>
	</div>
	<div id="footer">
		<input type="button" id="makeLink" value="Copy Settings to Link" style="margin-right: 5em">
		Source Code: <a href="https://github.com/DigitalPostma/FramingCalculator">github.com/DigitalPostma/FramingCalculator</a>
	</div>
	<script>
		$(document).ready(function(){
			// Setup canvas for high DPI displays
			var canvas = document.getElementById('framelineCanvas');
			var dpr = window.devicePixelRatio || 1;
			var rect = canvas.getBoundingClientRect();
			canvas.width = rect.width * dpr;
			canvas.height = rect.height * dpr;
			ctx = canvas.getContext('2d');
			ctx.scale(dpr, dpr);

			// Update input box for slider when it moves
			safetySlider.noUiSlider.on('update', function (values, handle) {
			    $('#safety-margin').val(values[handle]);
				update_fields();
			});

			// Handle updates to text entered in box for sider
			$('#safety-margin').on('change', function () {
			    safetySlider.noUiSlider.set(this.value);
				update_fields();
			});
			
			// Handle updates to other text box input
			$('.uiVar').on("change", function(){
				if (this.id.includes('Aspect'))
					uiVars[this.id] = parseFloat(this.value);
				else
					uiVars[this.id] = parseInt(this.value);
				update_slider_range()
			})
			
			// Handle changes to radio buttons
			$('#calcModeRadioBox').change( function() {
				var mode = $("input[name='calcMode']:checked").val();
				subpixelMode = (mode === "Subpixel");
				evenMode = (mode === "Doublepixel");
				update_slider_range();
			});
			
			// Make a URL and copy it to clipboard when the button is clicked
			$('#makeLink').click( function() {
				make_link();
			});
		})
	</script>
</body>
</html>

