<!doctype HTML>
<html>
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
    <title>Norville's Frame Chart Calculator</title>
	<meta name="tagline" content="You know, for kids!">
	<meta name="author" content="Peter Postma">
	<meta name="revised" content="September 2nd, 2020, 8:08pm">
	
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="nouislider.min.js"></script>
	<script type="text/javascript" src="jquery.ui.position.min.js"></script>
	<script type="text/javascript" src="jquery.contextMenu.min.js"></script>

	<link href="nouislider.min.css" rel="stylesheet">
	<link href="jquery.contextMenu.min.css" rel="stylesheet">
	<link rel="shortcut icon" href="favicon.ico"/>

	<style>
		body {
			font-family: "Liberation Sans", sans-serif;
			font-size: 0.8em;
			line-height: 1.5;
		}
		input[type=text] {
			font-size: 1em;
			width: 4em;
			margin-right: 1em;
		}
		fieldset {
			border: 1px black solid;
			width: 50.5em;
			padding: 1em;
			margin: 0em;
		}
		#sourceBox {
			margin-bottom: 0.5em;
		}
		#destAspect {
			margin-right: 0em;
			margin-bottom: 0.6em
		}
		.fit-to-menu {
			margin-left: 10em;
			border: 1px solid black;
			padding: 0.2em 0.8em;
			background: #EEE;
		}
		#sliderBox {
			position: relative;
			padding: 5px 20px 5px 20px;
			overflow: hidden;
			width: 50em;
			border: 1px solid black;
			margin-bottom: 0.8em;
		}
		#safety-slider-label {
			margin-top: 2.7em;
			width: 100%;
		}
		#safety-slider-label input {
            display: block;
            margin : 0 auto;
			width: 6em;
		}
		#safety-slider-min-label {
			float: left;
			color: #999;
		}
		#safety-slider-max-label {
			text-align: right;
			float: right;
			color: #999;
		}
		#calculatedValues {
			font-weight: bold;
		}
		#calculatedValues span {
			font-weight: normal;
		}
		.noUi-pips-horizontal {
			height: 20px;
		}
		#calculatedValues fieldset {
			border: 1px black solid;
			width: 24em;
		}
		legend {
			border: 1px black solid;
			margin-left: 1em;
			padding: 0em 0.8em;
			font-weight: bold;
		}
		#footer {
			margin: 1.5em;
			font-size: 0.8em;
		}
		#calModeBox {
			margin-top: 1em;
			line-height: 1.9em;
		}
		#calModeBox label {
			margin-right: 2em;
		}
		#heightVariance {
			color: #F99;
		}
		#canvasBox {
			width: 50em;
			margin-top: 1em;
		}
		#framelineCanvas {
		    padding-left: 0;
		    padding-right: 0;
		    margin-left: auto;
		    margin-right: auto;
		    display: block;
		    width: 90%;
		}
		ul.tabs{
			margin: 0px;
			padding: 0px;
			list-style: none;
		}
		ul.tabs li{
			position: relative;
			display: inline-block;
			top: 1px;
			padding: 5px 15px;
			cursor: pointer;
			border: 1px solid #AAA;
			border-bottom: 1px solid black;
			border-radius: 15px 15px 0px 0px;
			z-index: 2;
			color: #AAA;
		}
		ul.tabs li.current{
			border: 1px solid black;
			border-bottom: 1px solid white;
			color: #000;
		}
		#tab-0.current{
			background-image: linear-gradient(#99F, #FFF)
		}
		#tab-1.current{
			background-image: linear-gradient(#FF9, #FFF)
		}
		#tab-2.current{
			background-image: linear-gradient(#9F9, #FFF)
		}
		#tab-3.current{
			background-image: linear-gradient(#F99, #FFF)
		}
		.arrow-down {
			display: inline-block;
			width: 0; 
			height: 0; 
			border-left: 0.6em solid transparent;
			border-right: 0.6em solid transparent;
			border-top: 0.6em solid #888;
			top: -0.2em;
			position: relative;
			z-index: 99;
		}
		.inside-input {
			margin-left: -2.6em;
		}
	</style>
	
	<script>		
		let uiVars = {
		 	sourceWidth: 4096,
			sourceHeight: 2160,
			sourceAspect: 1.0,
		 	destWidth: 4096,
			destHeight: 0,    //calulated
			destAspect: 2.351
		};
		let frameVars = [
			{destAspect: 2.351, safetyMargin: 0.0},
			{destAspect: 2.351, safetyMargin: 0.0},
			{destAspect: 2.351, safetyMargin: 0.0},
			{destAspect: 2.351, safetyMargin: 0.0}
		];
		let currentFrameTab = 0;
		let subpixelMode = false;
		let evenMode = true;
		let fitHeight = false;
		let heightVariance = 0.0;
		var ctx;
		
		function calculate_values(destAspect, safetyMargin) {
			let vals = {
				extractionX: 0,
				extractionY: 0,
				extractionWidth: 0,
				extractionHeight: 0,
				aspectRatio: 0,
				hScale: 0,
				vScale: 0,
				hSafety: 0,
				vSafety: 0
			};
						
			vals.extractionWidth = uiVars.sourceWidth - (uiVars.sourceWidth * safetyMargin);
			vals.extractionX = (uiVars.sourceWidth - vals.extractionWidth) / 2.0;
			vals.hSafety = (uiVars.sourceWidth - vals.extractionWidth) / uiVars.sourceWidth * 100.0;

			vals.aspectRatio = destAspect;
			
			vals.extractionHeight = vals.extractionWidth / destAspect * uiVars.sourceAspect;
			vals.vSafety = (uiVars.sourceHeight - vals.extractionHeight) / uiVars.sourceHeight * 100.0;
			heightVariance = 0.0
			if (!subpixelMode) {
				var newHeight = Math.round(vals.extractionHeight);
				if (evenMode)
					newHeight = 2 * Math.round(vals.extractionHeight / 2);					
				heightVariance = vals.extractionHeight - newHeight;
				vals.extractionHeight = newHeight;
				vals.aspectRatio = vals.extractionWidth * uiVars.sourceAspect / vals.extractionHeight;
			}
			vals.extractionY = (uiVars.sourceHeight - vals.extractionHeight) / 2.0;
			
			if (!subpixelMode) {
				uiVars.destWidth = Math.round(uiVars.destWidth);
				uiVars.destHeight = Math.round(uiVars.destHeight);
				vals.extractionWidth = Math.round(vals.extractionWidth);
			}
			
			if (fitHeight) {
				vals.vScale = uiVars.destHeight / vals.extractionHeight;
				vals.hScale = vals.vScale * uiVars.sourceAspect;
			} else {
				vals.hScale = uiVars.destWidth / vals.extractionWidth;
				vals.vScale = vals.hScale / uiVars.sourceAspect;
			}
			return vals;
		}
		
		function draw_frame_lines() {			
			const width = $("#framelineCanvas").width();
			const height = $("#framelineCanvas").height();
			
			ctx.clearRect(0, 0, width, height);

			var hScale = width / uiVars.sourceWidth;
			var vScale = hScale;
			if ( uiVars.sourceHeight * vScale > height) {
				vScale = height/ uiVars.sourceHeight;
				hScale = vScale;
			}
			var offsetX = (width - uiVars.sourceWidth * hScale) / 2;
			var offsetY = (height - uiVars.sourceHeight * vScale) / 2;

			ctx.fillStyle = '#999'
			ctx.fillRect(offsetX, offsetY, uiVars.sourceWidth * hScale, uiVars.sourceHeight * vScale);
			
			ctx.globalAlpha = 0.6;
			
			for (var i = 0; i < 4; i++) {
				if (currentFrameTab != i) {
					if (i > 0 && frameVars[0].destAspect === frameVars[i].destAspect && frameVars[0].safetyMargin === frameVars[i].safetyMargin)
						continue;
					vals = calculate_values(frameVars[i].destAspect, frameVars[i].safetyMargin / 100.0);
				} else {
					vals = calculate_values(uiVars.destAspect, parseFloat($('#safety-margin').val()) / 100.0);
				}
				switch (i) {
					case 0:
						ctx.fillStyle = '#33F'
						break;
					case 1:
						ctx.fillStyle = '#FF3'
						break;
					case 2:
						ctx.fillStyle = '#3F3'
						break;
					case 3:
						ctx.fillStyle = '#F33'
						break;
				}
				ctx.fillRect(offsetX + vals.extractionX * hScale, offsetY + vals.extractionY * vScale,
							 vals.extractionWidth * hScale, vals.extractionHeight * vScale);
			}
			
			ctx.globalAlpha = 1.0;
			ctx.beginPath();
			ctx.moveTo(width / 2, height / 2 - 10);
			ctx.lineTo(width / 2, height / 2 + 10);
			ctx.moveTo(width / 2 - 10, height / 2);
			ctx.lineTo(width / 2 + 10, height / 2);
			ctx.stroke();
		}
		
		function update_fields() {
			uiVars.destHeight = Math.round(uiVars.destWidth / uiVars.destAspect);

			var vals = calculate_values(uiVars.destAspect, parseFloat($('#safety-margin').val()) / 100.0);
			
			for (let [key, value] of Object.entries(uiVars)) {
				$('#'+key).val(value);
			}
			for (let [key, value] of Object.entries(vals)) {
				var precision = 5
				if (!subpixelMode && String(key).startsWith('extraction')) {
					precision = (key === 'extractionX' || key === 'extractionY') ? 1 : 0; 
				}
				$('#'+key).text(value.toFixed(precision));
			}
			if (heightVariance != 0.0) {
				$('#heightVariance').text( ((heightVariance > 0) ? '+' : '') + heightVariance.toFixed(5) );
			} else {
				$('#heightVariance').text('');
			}

			draw_frame_lines();
		}
		
		function click_on_pip() {
		    var value = parseFloat(this.getAttribute('data-value'));
			if (parseFloat(this.style.left) > 99)
				value += 0.00001;
		    safetySlider.noUiSlider.set(value);
		}

		function update_slider_range() {
			var minPercentage = 0.0;
			var minWidth = uiVars.sourceWidth;
			if (uiVars.sourceHeight * uiVars.destAspect / uiVars.sourceAspect < minWidth) {
				minWidth = (uiVars.sourceHeight * uiVars.destAspect / uiVars.sourceAspect);
				if (!subpixelMode) {
					minWidth = Math.round(minWidth);
					if (evenMode && minWidth % 2 != 0)
						minWidth--
				}
				minPercentage =  (uiVars.sourceWidth - minWidth) / uiVars.sourceWidth * 100.0;
			}
			
			// Keep slide to usable range (not to sensitive and withing realistic bounds)
			var maxPercentage = ( minPercentage < 50.0 ) ? 50.0 : minPercentage + 20;
			if (maxPercentage > 99.0)
				maxPercentage = 99.0
			if (maxPercentage > minPercentage + 30.0) {
				maxPercentage = minPercentage + 30.0
				$('#safety-slider-max-label').html('<br>');
			} else {
				$('#safety-slider-max-label').html((uiVars.sourceAspect != 1.0 ? 'horizontal' : 'pixel') + ' doubling<br>');
			}
			var maxWidth = (1.0 - (maxPercentage / 100.0)) * uiVars.sourceWidth;
			if (!subpixelMode) {
				maxWidth = Math.round(maxWidth);
				if (evenMode) {
					maxWidth = 2 * Math.round(maxWidth / 2);
				}
				maxPercentage = (uiVars.sourceWidth - maxWidth) / uiVars.sourceWidth * 100.0;
			}
			
			var midPercentage = maxPercentage / 2.0;
			if ((uiVars.sourceWidth * uiVars.sourceAspect) > uiVars.destWidth) {				
				midPercentage = (uiVars.sourceWidth - uiVars.destWidth) / uiVars.sourceWidth * 100.0
			}
			if (midPercentage < minPercentage) {
				midPercentage = minPercentage + (maxPercentage - minPercentage) / 2.0;
			}

	        let sliderRange = {
	            'min': minPercentage,
	            'max': maxPercentage
	        }
			if (!subpixelMode) {
				var steps = minWidth-maxWidth;
				var interval = (maxPercentage - minPercentage) / steps;
				for ( var i = (evenMode) ? 2 : 1; i < steps; (evenMode) ? i = i + 2 : i++) {
					var key = (i * (100.0 / steps)) + '%';
					sliderRange[key] = (1.0 - ((minWidth - i) / uiVars.sourceWidth)) * 100.0;
				}
			}

			safetySlider.noUiSlider.updateOptions({
		        range: sliderRange,
				snap: (!subpixelMode),
			    pips: {
			        mode: 'values',
					values: [minPercentage, midPercentage, maxPercentage-0.00001],
			        density: 5
			    }
	    	});

			var pips = safetySlider.querySelectorAll('.noUi-value');

			for (var i = 0; i < pips.length; i++) {
			    pips[i].style.cursor = 'pointer';
			    pips[i].addEventListener('click', click_on_pip);
			}
		}
		
		function parse_URL() {
			var queries = window.location.search.replace(/^\?/, '').split('&'), split;
		    for( var i = 0; i < queries.length; i++ ) {
		        split = queries[i].split('=');
				if (split[0] === 'vars') {
					vars = split[1].split('_');
					if (vars.length < 12)
						break;
					uiVars.sourceWidth = parseInt(vars[0]);
					uiVars.sourceHeight = parseInt(vars[1]);
					uiVars.sourceAspect = parseFloat(vars[2]);
					uiVars.destWidth = parseInt(vars[3]);
					var x = 4;
					for (var y = 0; y < 4; y++) {
						frameVars[y].destAspect = parseFloat(vars[x++]);
						frameVars[y].safetyMargin = parseFloat(vars[x++]);
					}
				} else if (split[0] === 'tabs') {
					vars = split[1].split(',');
					if (vars.length == 4)
						for (var y = 0; y < 4; y++)
							$('#tab-' + y).text(decodeURIComponent(vars[y]));
				} else if (split[0] === 'mode') {
					if (split[1] === 'single') {
						subpixelMode = false;
						$('#calcMode_Singlepixel').prop('checked',true);
					} else if (split[1] === 'double') {
						evenMode = true;
						subpixelMode = false;
						$('#calcMode_Doublepixel').prop('checked',true);
					}
				} else if (split[0] === 'fitHeight' && split[1] === '1') {
					fitHeight = true;
					$('#calcMode_Height').prop('checked',true);
				}
		    }
			uiVars.destAspect = frameVars[0].destAspect;
			update_slider_range();
			$('#safety-margin').val(frameVars[0].safetyMargin).change();
		}
		
		function store_frame_values() {
			// Keep frames which haven't been adjusted the same as the first one
			var safetyMargin = parseFloat($('#safety-margin').val());
			
			if (currentFrameTab == 0) {
				for (var i = 1; i < 4; i++) {
				    if (frameVars[0].destAspect === frameVars[i].destAspect && frameVars[0].safetyMargin === frameVars[i].safetyMargin) {							
						frameVars[i].destAspect = uiVars.destAspect;
						frameVars[i].safetyMargin = safetyMargin;
					}
				}
			}

			frameVars[currentFrameTab].destAspect = uiVars.destAspect;
			frameVars[currentFrameTab].safetyMargin = safetyMargin;
		}
		
		const copy_to_clipboard = str => {
			const el = document.createElement('textarea');
			el.value = str;
			el.setAttribute('readonly', '');
			el.style.position = 'absolute';
			el.style.left = '-9999px';
			document.body.appendChild(el);
			const selected = document.getSelection().rangeCount > 0 ? document.getSelection().getRangeAt(0) : false;
			el.select();
			document.execCommand('copy');
			document.body.removeChild(el);
			if (selected) {
				document.getSelection().removeAllRanges();
				document.getSelection().addRange(selected);
			}
		};
		
		function make_link() {
			store_frame_values();
			
			var url = window.location.href.split('?')[0] + '?';
			url += 'vars=' + uiVars.sourceWidth + '_' + uiVars.sourceHeight + '_' + uiVars.sourceAspect + '_' + uiVars.destWidth;
			for (var i = 0; i < 4; i++)
				url +=  '_' + frameVars[i].destAspect + '_' + frameVars[i].safetyMargin;
			url += '&tabs=';
			for (var i = 0; i < 4; i++)
				url += encodeURIComponent($('#tab-' + i).text()) + ',';
			url = url.replace(/.$/,"&");
			
			if (evenMode)
				url += 'mode=double&';
			else if (!subpixelMode)
				url += 'mode=single&';
			if (fitHeight)
				url += 'fitHeight=1&';
			copy_to_clipboard(url.slice(0, -1));
		}
		
    </script>
</head>
<body onLoad="parse_URL()">
	<div id="sourceBox">
	    <fieldset>
	      <legend>Source</legend>
			Width <input id="sourceWidth" type="text" class="uiVar"/>
			Height <input id="sourceHeight" type="text" class="uiVar"/>
			Source Aspect <input id="sourceAspect" type="text" class="uiVar"/>		
			<span class="arrow-down inside-input source-aspect-menu"></span>
			<script>
				$(function(){
				    $.contextMenu({
				        selector: '.source-aspect-menu', 
				        trigger: 'left',
				        callback: function(key, options) {
				            uiVars.sourceAspect = key;
							update_slider_range();
				        },
					    position:  function(opt,  x,  y)  {
					      opt.$menu.position({
					        my:  'center top',
					        at:  'center bottom+8',
					        of:  opt.$trigger,
					      });
					    },
						items: {
				            "1": {name: "1:1 Spherical"},
				            "2": {name: "2:1 Anamorphic"},
				            "1.3": {name: "1.3:1 Anamorphic"},
				        }
				    });
				});
			</script>
		</fieldset>
	</div>
	
	<ul class="tabs">
		<li class="tab-link current" id="tab-0">Frame One</li>
		<li class="tab-link" id="tab-1">Frame Two</li>
		<li class="tab-link" id="tab-2">Frame Three</li>
		<li class="tab-link" id="tab-3">Frame Four</li>
	</ul>
	<script>
		var oriVal;
		$('.tabs').on('dblclick', 'li', function () {
		    oriVal = $(this).text();
		    $(this).text('');
		    $("<input type='text' class='tab-name'>").appendTo(this).focus();
		});
		$('.tabs').on('focusout', 'li > input', function () {
		    var $this = $(this);
		    $this.parent().text($this.val() || oriVal);
		    $this.remove();
		});
		jQuery(document).on('keydown', 'input.tab-name', function(ev) {
		    if(ev.key === 'Enter')
				$(':focus').blur();
		});
	</script>
	
    <div id="sliderBox">
		<div>Framing Aspect Ratio <input id="destAspect" type="text" class="uiVar"/><span style="margin-right: 1em">:1</span>
		<span class="fit-to-menu">Fit to <span class="arrow-down"></span></span></div>
		<script>
			$(function(){
			    $.contextMenu({
			        selector: '.fit-to-menu', 
			        trigger: 'left',
				    position:  function(opt,  x,  y)  {
				      opt.$menu.position({
				        my:  'center top',
				        at:  'center bottom',
				        of:  opt.$trigger,
				      });
				    },
				    build: function($triggerElement, e){
				        return {
					        callback: function(key, options) {
								if (key == 0) {
									fitToWidth = uiVars.sourceWidth;
									fitToHeight = uiVars.sourceHeight;
								} else {
									key--;
									vals = calculate_values(frameVars[key].destAspect, frameVars[key].safetyMargin / 100.0);
									fitToWidth = vals.extractionWidth;
									fitToHeight = vals.extractionHeight;
								}
								if ( fitToHeight * uiVars.destAspect / uiVars.sourceAspect <= fitToWidth )
									safetyMargin = (uiVars.sourceWidth - fitToHeight * uiVars.destAspect / uiVars.sourceAspect) / uiVars.sourceWidth;
								else
									safetyMargin = (uiVars.sourceWidth - fitToWidth) / uiVars.sourceWidth;
								$('#safety-margin').val(safetyMargin * 100.0).change();
					        },
				            items: {
					            "0": {name: "Source"},
					            "1": {name: $('#tab-0').text(), disabled: function(key) { return (currentFrameTab == --key)} },
					            "2": {name: $('#tab-1').text(), disabled: function(key) { return (currentFrameTab == --key)} },
								"3": {name: $('#tab-2').text(), disabled: function(key) { return (currentFrameTab == --key)} },
								"4": {name: $('#tab-3').text(), disabled: function(key) { return (currentFrameTab == --key)} }
				            }
				        };
				    }
			    });
			});
		</script>
		Percent Safety Margin (Width)
        <div id="safety-slider"></div>
        <div id="safety-slider-label">
			<span id="safety-slider-min-label">full width</span>
			<span id="safety-slider-max-label"></span>
			<input id="safety-margin" type="text"/>
		</div>
	    <script>
			var safetySlider = document.getElementById('safety-slider');

			noUiSlider.create(safetySlider, {
			    start: [0],
			    range: {
			        'min': 0,
			        'max': 100
			    },
			    pips: {
			        mode: 'values',
					values: [0, 50, 100],
			        density: 4
			    },
			});
		</script>
	</div>
	<div id="calculatedValues">
	    <fieldset style="float: left; margin-right: 0.5em">
	      <legend>Extraction Area</legend>
			Top-left X: <span id="extractionX"></span><br>
			Top-left Y: <span id="extractionY"></span><br><br>
			Width: <span id="extractionWidth"></span><br>
			Height: <span id="extractionHeight"></span> <span id="heightVariance"></span><br><br>
			Aspect ratio: <span id="aspectRatio"></span><br>
	    </fieldset>
	    <fieldset>
	      <legend>Safety Margin</legend>
			Horizontal (%): <span id="hSafety"></span><br>
			Vertical (%): <span id="vSafety"></span><br>
		</fieldset>
		<fieldset style="margin-top: 0.5em">
  	      <legend>Resized Output</legend>	
  			Width <input id="destWidth" type="text" class="uiVar"/>
			<span class="arrow-down inside-input destWidth-menu"></span>
			<script>
				$(function(){
				    $.contextMenu({
				        selector: '.destWidth-menu', 
				        trigger: 'left',
				        callback: function(key, options) {
				            uiVars.destWidth = key;
							update_slider_range();
				        },
					    position:  function(opt,  x,  y)  {
					      opt.$menu.position({
					        my:  'center top',
					        at:  'center bottom+8',
					        of:  opt.$trigger,
					      });
					    },
						items: {
				            "1920": {name: "HD 1920x1080"},
				            "3840": {name: "UHD 3840x2160"},
				            "1998": {name: "DCI 2K Flat 1998x1080"},
							"2048": {name: "DCI 2K Scope 2048x858"},
							"3996": {name: "DCI 4K Flat 3996x2160"},
							"4096": {name: "DCI 4K Scope 4096x1716"},
				        }
				    });
				});
			</script>
  			Height <input id="destHeight" type="text" disabled/><br>
			Horizontal scale: <span id="hScale"></span><br>
			Vertical scale: <span id="vScale"></span><br>
	    </fieldset>
	</div>
	<div id="canvasBox">
		<canvas id="framelineCanvas"></canvas>
	</div>
	<div id="calModeBox">
	    <fieldset>
			<legend>Calculation Modes</legend>
			<form id="calcModeRadioBox">
				Extraction Rounding :
				<input type="radio" name="calcMode" id="calcMode_Subpixel" value="Subpixel"/><label for="calcMode_Subpixel">Subpixel </label>
				<input type="radio" name="calcMode" id="calcMode_Singlepixel" value="Singlepixel"/><label for="calcMode_Singlepixel">Whole pixel</label>
				<input type="radio" name="calcMode" id="calcMode_Doublepixel" value="Doublepixel" CHECKED/><label for="calcMode_Doublepixel">Even pixel</label>
				<br>
				Scaling :
				<input type="radio" name="scalingMode" id="calcMode_Width" value="Width" CHECKED/><label for="calcMode_Width">Fit Width</label>
				<input type="radio" name="scalingMode" id="calcMode_Height" value="Height"/><label for="calcMode_Height">Fit Height</label>			
			</form>
		</fieldset>
	</div>
	<div id="footer">
		<input type="button" id="makeLink" value="Copy Settings to Link" style="margin-right: 5em">
		Source Code: <a href="https://github.com/DigitalPostma/FramingCalculator">github.com/DigitalPostma/FramingCalculator</a>
	</div>
	<script>
		$(document).ready(function(){			
			// Setup canvas for high DPI displays
			var canvas = document.getElementById('framelineCanvas');
			var dpr = window.devicePixelRatio || 1;
			var rect = canvas.getBoundingClientRect();
			canvas.width = rect.width * dpr;
			canvas.height = rect.height * dpr;
			ctx = canvas.getContext('2d');
			ctx.scale(dpr, dpr);

			// Update input box for slider when it moves
			safetySlider.noUiSlider.on('update', function (values, handle) {
			    $('#safety-margin').val(values[handle]);
				update_fields();
			});

			// Handle updates to text entered in box for sider
			$('#safety-margin').on('change', function () {
			    safetySlider.noUiSlider.set(this.value);
				update_fields();
			});
			
			// Handle updates to other text box input
			$('.uiVar').on("change", function(){
				if (this.id.includes('Aspect')) {
					uiVars[this.id] = parseFloat(this.value);
					if (isNaN(uiVars[this.id]) || uiVars[this.id] < 0.5)
						uiVars[this.id] = 1;
				} else {
					uiVars[this.id] = parseInt(this.value);
					if (isNaN(uiVars[this.id]) || uiVars[this.id] < 1)
						uiVars[this.id] = 1000;
				}
				update_slider_range();
			})
			
			// Handle changes to radio buttons
			$('#calcModeRadioBox').change( function() {
				var mode = $("input[name='calcMode']:checked").val();
				subpixelMode = (mode === "Subpixel");
				evenMode = (mode === "Doublepixel");
				
				var mode = $("input[name='scalingMode']:checked").val();
				fitHeight = (mode === "Height");
				
				update_slider_range();
			});
			
			// Make a URL and copy it to clipboard when the button is clicked
			$('#makeLink').click( function() {
				make_link();
			});
			
			// Handle selecting different frame tabs
			$('ul.tabs li').click(function() {
				selectedFrameTab = this.id.slice(-1)
				if (selectedFrameTab == currentFrameTab)
					return;
				
				$('ul.tabs li').removeClass('current');
				$(this).addClass('current');
				
				store_frame_values();
				
				currentFrameTab = selectedFrameTab;
				uiVars.destAspect = frameVars[selectedFrameTab].destAspect;
				update_slider_range();
				$('#safety-margin').val(frameVars[selectedFrameTab].safetyMargin).change();
			});

		})
	</script>
</body>
</html>